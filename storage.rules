
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // By default, nobody can read or write.
    // Reading is granted on a per-file basis via signed URLs generated by the backend.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Users can only write to their own designated profile folder.
    // The client SDK must upload files to this exact path format.
    match /users/{userId}/profile/{fileName} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Admins can write to station documents (agreements, compliance reports, etc.)
    match /stations/{stationId}/{docType}/{fileName} {
       allow write: if request.auth != null && request.auth.token.email == 'admin@riverph.com';
    }

    // Admins can write to a user's contract folder.
    match /userContracts/{userId}/{fileName} {
       allow write: if request.auth != null && request.auth.token.email == 'admin@riverph.com';
    }

    // Admins can write to a user's delivery proof folder.
    match /users/{userId}/deliveries/{fileName} {
      allow write: if request.auth != null && request.auth.token.email == 'admin@riverph.com';
    }

    // Authenticated users can upload proof of payment to their own payments folder.
    match /users/{userId}/payments/{fileName} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
