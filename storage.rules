
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function isAdmin() {
      // The user is an admin if their custom claim 'admin' is true.
      // Or, as a fallback, if they are the designated admin email.
      return request.auth.token.admin == true || request.auth.token.email == 'admin@riverph.com';
    }

    // 1. Global Admin Rule: Admins can read and write ANY file.
    match /{allPaths=**} {
      allow read, write: if isAdmin();
    }

    // 2. User-Specific Rules: Users can manage files in their own directory.
    // An admin can also write here because of the global rule above.
    match /users/{userId}/{allPaths=**} {
      // Any authenticated user can read files (e.g. profile pictures).
      allow read: if request.auth != null;
      // Only the owner of the folder can write files to it.
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 3. User Contracts: Managed by admins, readable by any authenticated user.
    match /userContracts/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      // Write is handled by the global admin rule.
    }

    // 4. Station Documents: Managed by admins, readable by any authenticated user.
    match /stations/{stationId}/{allPaths=**} {
      allow read: if request.auth != null;
       // Write is handled by the global admin rule.
    }

    // 5. Public Assets: Read-only for everyone, including unauthenticated users.
    // This is necessary for images on login/public pages.
    match /River Mobile/{allPaths=**} {
      allow read;
    }
    match /Sales Portal/{allPaths=**} {
      allow read;
    }
  }
}
