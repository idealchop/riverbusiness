rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function isAdmin() {
      // User is an admin if their custom claim 'admin' is true, or their email is the designated admin email.
      return request.auth.token.admin == true || request.auth.token.email == 'admin@riverph.com';
    }

    // --- ADMIN-SPECIFIC WRITE RULES ---

    // Rule for admins uploading delivery proofs or sanitation reports on behalf of users.
    // This matches the paths used in the AdminDashboard component.
    match /admin_uploads/{adminId}/{path=**} {
      allow read, write: if request.auth.uid == adminId && isAdmin();
    }

    // Rule for admins uploading contracts for users.
    match /userContracts/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Rule for admins managing water station documents (agreements, compliance).
    match /stations/{stationId}/{path=**} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    // --- USER-SPECIFIC WRITE RULES ---

    // Users can upload their own profile photo.
    match /users/{userId}/profile/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // Users can upload their own payment proofs.
    match /users/{userId}/payments/{fileName} {
       allow read: if request.auth != null;
       allow write: if request.auth.uid == userId;
    }
    
    // --- READ-ONLY & PUBLIC RULES ---

    // As a fallback, authenticated users can generally read from user folders
    // (e.g., to see another user's profile picture if needed).
    // Write access is denied here and must be granted by a more specific rule above.
    match /users/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
    }

    // Public assets for login/marketing pages are readable by anyone.
    match /River Mobile/{allPaths=**} {
      allow read;
    }
    match /Sales Portal/{allPaths=**} {
      allow read;
    }
  }
}
